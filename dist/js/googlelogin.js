var _=Object.defineProperty;var i=(o,e)=>_(o,"name",{value:e,configurable:!0});console.log("\u{1F525} Script loaded!");var r=supabase.createClient("https://pxmsgzfufvwxpnyeobwk.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4bXNnemZ1ZnZ3eHBueWVvYndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjU1OTksImV4cCI6MjA2NzM0MTU5OX0.-fRzI_259AIkq60Ck7PcgpX2SThnp8rBwVGglKxgY2U",{auth:{persistSession:!0,autoRefreshToken:!0,storage:localStorage}}),c=document.getElementById("authArea");c.innerHTML="<li>Loading...</li>";console.log("\u2699\uFE0F Supabase client initialized:",r);async function v(){console.log("\u{1F431} handleOAuthRedirect() called");let e=new URLSearchParams(window.location.search).get("code"),t=window.location.hash;if(console.log("\u{1F50D} URL params:",window.location.search),console.log("\u{1F50D} URL hash:",t),e){console.log("\u{1F389} Found ?code param:",e);let{data:n,error:s}=await r.auth.exchangeCodeForSession(e);s?console.error("\u274C Error exchanging code:",s.message):console.log("\u2705 Session established:",n.session),window.history.replaceState({},document.title,window.location.pathname)}else t.includes("access_token")?console.log("\u{1F389} Found #access_token \u2014 letting Supabase handle it."):console.log("\u26A0\uFE0F No OAuth params found.")}i(v,"handleOAuthRedirect");async function p(o){console.log("\u{1F3AD} renderUser() called");let e=o;if(!e){let{data:n,error:s}=await r.auth.getSession();e=n.session,console.log("client is",r),console.log("client.auth is",r.auth),console.log("\u{1F4BE} getSession() response:",e,s)}let t=e?.user;if(console.log("\u{1F5DD}\uFE0F Current user:",t),t){console.log("\u2705 Logged in user:",t);let n=t.email,[s,a]=n.split("@"),d=`${s.length>7?s.slice(0,7)+"...":s}@${a}`;U().then(l=>{c.innerHTML=`
        <div class="profile-dropdown">
          <button class="profile-btn">
            <img src="${l.profile_picture||t.user_metadata.picture}" alt="avatar" class="profile-pic">
            <span class="profile-name">${l.display_name||t.user_metadata.full_name||d}</span>
          </button>
          <div class="dropdown-content">
            <a href="/myprofile" style="color:white;" id="BEWHITEBRO">My Profile</a>
            <a href="#" id="logoutBtn" style="color:white;">Logout</a>
          </div>
        </div>
      `,document.getElementById("logoutBtn").onclick=async u=>{u.preventDefault(),console.log("\u{1F6AA} Logging out..."),await r.auth.signOut(),setTimeout(()=>p(),100)}})}else console.log("\u{1F645} No user logged in."),c.innerHTML=`
  <li>
    <a href="#" id="loginBtn" style="display: flex; align-items: center; gap: 8px;">
      <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo" style="height: 16px; border-radius:10px;">
      <span>Login</span>
    </a>
  </li>
`,document.getElementById("loginBtn").onclick=async n=>{n.preventDefault(),console.log("\u{1F511} Starting OAuth sign in..."),await r.auth.signOut(),await r.auth.signInWithOAuth({provider:"google",options:{prompt:"select_account consent"}})},console.log("\u{1F511} Login button set up.")}i(p,"renderUser");r.auth.onAuthStateChange(async(o,e)=>{if(console.log("\u26A1 Auth state changed:",o,e),e===null&&window.location.hash.includes("access_token")){console.log("\u{1F9F9} Cleaning up #access_token from URL"),window.location.hash="";return}if(e===null){console.log("\u{1F645} No session found."),c.innerHTML='<li style="color:white;" class="emailText">Not logged in</li>';return}await p(e),console.log("\u{1F504} User UI re-rendered.")});console.log("\u{1F3C3} Running handleOAuthRedirect() & renderUser()...");v().then(()=>p());console.log("\u{1F680} Initialization complete.");async function f(){let{data:{user:o},error:e}=await r.auth.getUser();return e?(console.error("Failed to get UID:",e),null):o.id}i(f,"getUID");async function A({title:o,file:e,description:t,image:n,icon:s,author:a,category:g,creatoruid:d,shortdescription:l,info:u}){if(!o||!e)return{error:"Fill title and file!"};let I=e.name.split(".").pop(),h=`mods/${Date.now()}.${I}`,{error:m}=await r.storage.from("mod").upload(h,e);if(m)return{error:m.message};let{error:w}=await r.from("mod").insert({title:o,description:t,image:n,icon:s,author:a,category:g,info:u,file_path:h,created_at:new Date,creatoruid:d,shortdescription:l});return w?{error:w.message}:{success:!0}}i(A,"uploadMod");async function U(){let o=await f();if(!o)return null;let{data:e,error:t}=await r.from("profiles").select("*").eq("uid",o);if(t)return console.error("Failed to fetch profile:",t),null;if(!e||e.length===0){let{data:n,error:s}=await r.from("profiles").insert({uid:o}).select().single();return s?(console.error("Failed to create new profile:",s),null):n}return e[0]}i(U,"getProfile");async function B({display_name:o,profile_picture:e,bio:t}){let n=await f();if(!n)return{error:"User not logged in!"};let{data:s,error:a}=await r.from("profiles").upsert({uid:n,display_name:o,profile_picture:e,bio:t},{onConflict:["uid"],returning:"representation"});return a?{error:a.message}:{success:!0,data:s}}i(B,"updateProfile");var b="https://pxmsgzfufvwxpnyeobwk.supabase.co/rest/v1/mod",y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4bXNnemZ1ZnZ3eHBueWVvYndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjU1OTksImV4cCI6MjA2NzM0MTU5OX0.-fRzI_259AIkq60Ck7PcgpX2SThnp8rBwVGglKxgY2U";async function E(o){let e=await fetch(`${b}?creatoruid=eq.${o}`,{method:"GET",headers:{apikey:y,Authorization:`Bearer ${y}`,"Content-Type":"application/json",Accept:"application/json"}});return e.ok?await e.json():(console.error("Failed request:",e.status,await e.text()),null)}i(E,"getUserMods");(async()=>{try{let o=await f(),e=await E(o);if(e)for(let t of e)await S(t)}catch(o){console.error("\u274C Error initializing user mods:",o)}})();async function S(o){let{data:e}=await r.from("versions").select("*").eq("mod_id",o.id).eq("approved",!0).order("created_at",{ascending:!0});if(e&&e.length>0){let t=e[e.length-1];o.title=t.proposed_title,o.shortdescription=t.proposed_description,o.file_path=t.proposed_file_path}return o}i(S,"applyApprovedVersions");async function O(o){let{data:e,error:t}=await r.from("versions").select("*").eq("id",o).single();if(t)return console.error(t);let{error:n}=await r.from("mod").update({title:e.proposed_title,shortdescription:e.proposed_description,file_path:e.proposed_file_path}).eq("id",e.mod_id);if(n)return console.error(n);await r.from("versions").update({approved:!0}).eq("id",o),console.log("Version approved and mod updated!")}i(O,"approveVersion");async function k(o){if(!o)return console.error("\u274C getProfile called with no uid"),null;let{data:e,error:t}=await r.from("profiles").select("*").eq("uid",o).limit(1);if(t)return console.error("\u274C Failed to fetch profile:",t),null;if(!e||e.length===0){console.log("\u2139\uFE0F No profile found for uid:",o);let{data:n,error:s}=await r.from("profiles").insert({uid:o}).select().single();return s?(console.error("\u274C Failed to create new profile:",s),null):n}return e[0]}i(k,"getUserProfileByUID");export{O as approveVersion,U as getProfile,f as getUID,E as getUserMods,k as getUserProfileByUID,B as updateProfile,A as uploadMod};
