console.log("\u{1F525} Script loaded!");var r=supabase.createClient("https://pxmsgzfufvwxpnyeobwk.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4bXNnemZ1ZnZ3eHBueWVvYndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjU1OTksImV4cCI6MjA2NzM0MTU5OX0.-fRzI_259AIkq60Ck7PcgpX2SThnp8rBwVGglKxgY2U",{auth:{persistSession:!0,autoRefreshToken:!0,storage:localStorage}}),l=document.getElementById("authArea");l.innerHTML="<li>Loading...</li>";console.log("\u2699\uFE0F Supabase client initialized:",r);async function I(){console.log("\u{1F431} handleOAuthRedirect() called");let e=new URLSearchParams(window.location.search).get("code"),t=window.location.hash;if(console.log("\u{1F50D} URL params:",window.location.search),console.log("\u{1F50D} URL hash:",t),e){console.log("\u{1F389} Found ?code param:",e);let{data:n,error:s}=await r.auth.exchangeCodeForSession(e);s?console.error("\u274C Error exchanging code:",s.message):console.log("\u2705 Session established:",n.session),window.history.replaceState({},document.title,window.location.pathname)}else t.includes("access_token")?console.log("\u{1F389} Found #access_token \u2014 letting Supabase handle it."):console.log("\u26A0\uFE0F No OAuth params found.")}async function u(o){console.log("\u{1F3AD} renderUser() called");let e=o;if(!e){let{data:n,error:s}=await r.auth.getSession();e=n.session,console.log("client is",r),console.log("client.auth is",r.auth),console.log("\u{1F4BE} getSession() response:",e,s)}let t=e?.user;if(console.log("\u{1F5DD}\uFE0F Current user:",t),t){console.log("\u2705 Logged in user:",t);let n=t.email,[s,i]=n.split("@"),c=`${s.length>7?s.slice(0,7)+"...":s}@${i}`;_().then(a=>{l.innerHTML=`
        <div class="profile-dropdown">
          <button class="profile-btn">
            <img src="${a.profile_picture||t.user_metadata.picture}" alt="avatar" class="profile-pic">
            <span class="profile-name">${a.display_name||t.user_metadata.full_name||c}</span>
          </button>
          <div class="dropdown-content">
            <a href="/myprofile" style="color:white;" id="BEWHITEBRO">My Profile</a>
            <a href="#" id="logoutBtn" style="color:white;">Logout</a>
          </div>
        </div>
      `,document.getElementById("logoutBtn").onclick=async d=>{d.preventDefault(),console.log("\u{1F6AA} Logging out..."),await r.auth.signOut(),setTimeout(()=>u(),100)}})}else console.log("\u{1F645} No user logged in."),l.innerHTML=`
  <li>
    <a href="#" id="loginBtn" style="display: flex; align-items: center; gap: 8px;">
      <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo" style="height: 16px; border-radius:10px;">
      <span>Login</span>
    </a>
  </li>
`,document.getElementById("loginBtn").onclick=async n=>{n.preventDefault(),console.log("\u{1F511} Starting OAuth sign in..."),await r.auth.signOut(),await r.auth.signInWithOAuth({provider:"google",options:{prompt:"select_account consent"}})},console.log("\u{1F511} Login button set up.")}r.auth.onAuthStateChange(async(o,e)=>{if(console.log("\u26A1 Auth state changed:",o,e),e===null&&window.location.hash.includes("access_token")){console.log("\u{1F9F9} Cleaning up #access_token from URL"),window.location.hash="";return}if(e===null){console.log("\u{1F645} No session found."),l.innerHTML='<li style="color:white;" class="emailText">Not logged in</li>';return}await u(e),console.log("\u{1F504} User UI re-rendered.")});console.log("\u{1F3C3} Running handleOAuthRedirect() & renderUser()...");I().then(()=>u());console.log("\u{1F680} Initialization complete.");async function p(){let{data:{user:o},error:e}=await r.auth.getUser();return e?(console.error("Failed to get UID:",e),null):o.id}async function E({title:o,file:e,description:t,image:n,icon:s,author:i,category:f,creatoruid:c,shortdescription:a,info:d}){if(!o||!e)return{error:"Fill title and file!"};let y=e.name.split(".").pop(),g=`mods/${Date.now()}.${y}`,{error:h}=await r.storage.from("mod").upload(g,e);if(h)return{error:h.message};let{error:m}=await r.from("mod").insert({title:o,description:t,image:n,icon:s,author:i,category:f,info:d,file_path:g,created_at:new Date,creatoruid:c,shortdescription:a});return m?{error:m.message}:{success:!0}}async function _(){let o=await p();if(!o)return null;let{data:e,error:t}=await r.from("profiles").select("*").eq("uid",o);if(t)return console.error("Failed to fetch profile:",t),null;if(!e||e.length===0){let{data:n,error:s}=await r.from("profiles").insert({uid:o}).select().single();return s?(console.error("Failed to create new profile:",s),null):n}return e[0]}async function S({display_name:o,profile_picture:e,bio:t}){let n=await p();if(!n)return{error:"User not logged in!"};let{data:s,error:i}=await r.from("profiles").upsert({uid:n,display_name:o,profile_picture:e,bio:t},{onConflict:["uid"],returning:"representation"});return i?{error:i.message}:{success:!0,data:s}}var v="https://pxmsgzfufvwxpnyeobwk.supabase.co/rest/v1/mod",w="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4bXNnemZ1ZnZ3eHBueWVvYndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjU1OTksImV4cCI6MjA2NzM0MTU5OX0.-fRzI_259AIkq60Ck7PcgpX2SThnp8rBwVGglKxgY2U";async function U(o){let e=await fetch(`${v}?creatoruid=eq.${o}`,{method:"GET",headers:{apikey:w,Authorization:`Bearer ${w}`,"Content-Type":"application/json",Accept:"application/json"}});return e.ok?await e.json():(console.error("Failed request:",e.status,await e.text()),null)}(async()=>{try{let o=await p(),e=await U(o);if(e)for(let t of e)await b(t)}catch(o){console.error("\u274C Error initializing user mods:",o)}})();async function b(o){let{data:e}=await r.from("versions").select("*").eq("mod_id",o.id).eq("approved",!0).order("created_at",{ascending:!0});if(e&&e.length>0){let t=e[e.length-1];o.title=t.proposed_title,o.shortdescription=t.proposed_description,o.file_path=t.proposed_file_path}return o}async function x(o){let{data:e,error:t}=await r.from("versions").select("*").eq("id",o).single();if(t)return console.error(t);let{error:n}=await r.from("mod").update({title:e.proposed_title,shortdescription:e.proposed_description,file_path:e.proposed_file_path}).eq("id",e.mod_id);if(n)return console.error(n);await r.from("versions").update({approved:!0}).eq("id",o),console.log("Version approved and mod updated!")}async function A(o){if(!o)return console.error("\u274C getProfile called with no uid"),null;let{data:e,error:t}=await r.from("profiles").select("*").eq("uid",o).limit(1);if(t)return console.error("\u274C Failed to fetch profile:",t),null;if(!e||e.length===0){console.log("\u2139\uFE0F No profile found for uid:",o);let{data:n,error:s}=await r.from("profiles").insert({uid:o}).select().single();return s?(console.error("\u274C Failed to create new profile:",s),null):n}return e[0]}export{x as approveVersion,_ as getProfile,p as getUID,U as getUserMods,A as getUserProfileByUID,S as updateProfile,E as uploadMod};
